{% extends "base.html" %}
{% block title %}{{ block.super }} | Planning {% endblock %}
{% block main %}
<h1>Planning</h1>
<br/>
<div>
	{{ form.as_table }} <br />
</div>
<table id="table_planning">
	<tbody id="body_planning">
		<tr id="entete_planning">
			<td></td>
			<td id="1">Lundi</td>
			<td id="2">Mardi</td>
			<td id="3">Mercredi</td>
			<td id="4">Jeudi</td>
			<td id="5">Vendredi</td>
			<td id="6">Samedi</td>
		</tr>
		{% load utils %}
		{% for cpt in taille %}
			<tr id="l_{{ cpt|incrementSept:cpt }}">
				<td>{{ cpt|incrementSept:cpt }} à {{ cpt|incrementHuit:cpt }}h</td>
				<td id="l_{{ cpt|incrementSept:cpt }}_d_1"></td>
				<td id="l_{{ cpt|incrementSept:cpt }}_d_2"></td>
				<td id="l_{{ cpt|incrementSept:cpt }}_d_3"></td>
				<td id="l_{{ cpt|incrementSept:cpt }}_d_4"></td>
				<td id="l_{{ cpt|incrementSept:cpt }}_d_5"></td>
				<td id="l_{{ cpt|incrementSept:cpt }}_d_6"></td>
			</tr>
		{% endfor %}
	</tbody>
</table>
<a href="{% url 'addSoutenance' %}" class="btn btn-primary">Ajouter une Soutenance</a>

{% endblock %}
{% block libraries %}{{ block.super }}
	<link rel="stylesheet" type="text/css" href="/static/css/smoothness/jquery-ui-1.10.4.custom.min.css" media="screen">
	<script type="text/javascript" src="/static/js/jquery-ui-1.10.4.custom.min.js"></script>
	<script type="text/javascript" src="/static/js/utils.js"></script>
{% endblock %}
{% block js %}

	const tab = "#table_planning";
	const theadTab = "#entete_planning";
	const bodyTab = "#body_planning";
	const saveTableau = $(tab).html();

	function reinitTableaux(theTableau){
		console.log('réinitialisation du planning');
		$(theTableau).html(saveTableau);
		console.log('planning réinitialisé');
	}

	function remplirTableaux(bodyTab, data){
		$.each(data, function( index, value ) {
			var heure = value['fields']['datePassage']
				// recuperation de l'heure et minutes
				.split("T")[1]
				// recuperation seule de l'heure
				.split(":")[0];

			var laDate = value['fields']['datePassage']
				// recuperation de la date sans l'heure
				.split('T')[0]
				// mise en tableau de l'année, mois, jour
				.split('-');
			var jour = new Date(laDate[0], laDate[1] - 1, laDate[2]).getDay();

			// recherche de l'id de la cellule cible
			var target = '#l_' + heure + '_d_' + jour;

			console.log('soutenance sur ' + target);
			$(target).html($(target).html() + value['fields']['salle']);
		});
	}

	$( document ).ready( function() {

		becomeDatePicker("#id_datePassage");

		$("#id_datePassage").change(function(){
			console.log('récupération du range de la semaine');
			var laDate = $('#id_datePassage').val()
					// recuperation de la date sans l'heure
					.split('T')[0]
					// mise en tableau de l'année, mois, jour
					.split('-');
			var jour = new Date(laDate[0], laDate[1] - 1, laDate[2]);
			var curJour = new Date(jour), finSem = new Date(jour);
			curJour.setDate(parseInt(laDate[2]) - (jour.getDay() - 1));
			finSem.setDate(parseInt(laDate[2]) + (6 - jour.getDay()));
			console.log('commence : ' + curJour);
			console.log('termine : ' + finSem);

			reinitTableaux(bodyTab);

			for(var i = curJour; i <= finSem; i.setDate(i.getDate() + 1)){
				console.log('range : ' + i);
				$.ajax({
					url: '{% url 'find_planning' %}',
					data: {
						'date': i.toLocaleFormat("%Y-%m-%d")
					},
					type: 'GET',
					dataType: 'json',
					contentType: 'application/json'
				}).done(function(data, textStatus, jqXHR){

					remplirTableaux(bodyTab, data);

				}).fail(function(jqXHR, textStatus, errorThrown){
					console.log("ajax failed");
					alert(errorThrown);
				});
			}
		});
	});
	active_tab="#tab-planning"
{% endblock %}