{% extends "base.html" %}
{% block title %}{{ block.super }} | Planning {% endblock %}
{% block main %}
<h1>Planning</h1>
<br/>
<div>
	{{ form.as_table }} <br />
</div>
<div class="row">
	<div class="col-xs-5 col-lg-offset-1 col-md-offset-1 col-md-5 col-lg-5">
		<table id="table_planning">
			<tbody id="body_planning">
				<tr id="entete_planning">
					<td></td>
					<td id="1">Lundi</td>
					<td id="2">Mardi</td>
					<td id="3">Mercredi</td>
					<td id="4">Jeudi</td>
					<td id="5">Vendredi</td>
					<td id="6">Samedi</td>
				</tr>
				{% load utils %}
				{% for cpt in taille %}
					<tr id="l_{{ cpt|incrementSept:cpt }}">
						<td>{{ cpt|incrementSept:cpt }} à {{ cpt|incrementHuit:cpt }}h</td>
						<td id="l_{{ cpt|incrementSept:cpt }}_d_1"></td>
						<td id="l_{{ cpt|incrementSept:cpt }}_d_2"></td>
						<td id="l_{{ cpt|incrementSept:cpt }}_d_3"></td>
						<td id="l_{{ cpt|incrementSept:cpt }}_d_4"></td>
						<td id="l_{{ cpt|incrementSept:cpt }}_d_5"></td>
						<td id="l_{{ cpt|incrementSept:cpt }}_d_6"></td>
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	<div class="col-xs-5 col-lg-offset-1 col-md-offset-1 col-md-5 col-lg-5">
		<table id="table_planningJ">
			<tbody id="body_planningJ">
				<tr id="entete_planningJ">
					<td></td>
				</tr>
				{% load utils %}
				{% for cpt in taille %}
					<tr id="l_{{ cpt|incrementSept:cpt }}">
						<td>{{ cpt|incrementSept:cpt }} à {{ cpt|incrementHuit:cpt }}h</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>
<a href="{% url 'addSoutenance' %}" class="btn btn-primary">Ajouter une Soutenance</a>

{% endblock %}
{% block libraries %}{{ block.super }}
	<link rel="stylesheet" type="text/css" href="/static/css/smoothness/jquery-ui-1.10.4.custom.min.css" media="screen">
	<script type="text/javascript" src="/static/js/jquery-ui-1.10.4.custom.min.js"></script>
	<script type="text/javascript" src="/static/js/utils.js"></script>
{% endblock %}
{% block js %}

	const tab = "#table_planning";
	const theadTab = "#entete_planning";
	const bodyTab = "#body_planning";
	const saveTableau = $(tab).html();

	const tabJ = "#table_planningJ";
	const theadTabJ = "#entete_planningJ";
	const bodyTabJ = "#body_planningJ";
	const saveTableauJ = $(tabJ).html();

	const  month=new Array();
	month[0]="Janvier";
	month[1]="Février";
	month[2]="Mars";
	month[3]="Avril";
	month[4]="Mai";
	month[5]="Juin";
	month[6]="Juillet";
	month[7]="Août";
	month[8]="Septembre";
	month[9]="Octobre";
	month[10]="Novembre";
	month[11]="Decembre";

	function reinitTableaux(theTableau, savedTableau){
		console.log('réinitialisation du planning : ' + theTableau);
		$(theTableau).html(savedTableau);
		console.log('planning réinitialisé : ' + theTableau);
	}

	function getListeSalles(listeSoutenance){
		var salles = [];
		console.log('récupération des salles');
		$.each(listeSoutenance, function(index, value){
			if($.inArray(value['fields']['salle'], salles) == -1){
				console.log('nouvelles salles : ' + value['fields']['salle']);
				salles.push(value['fields']['salle']);
			}
		});
		salles.sort();
		console.log(salles);
		return salles;
	}

	function putTheadTabbleau(theTableauEntete, listeSoutenance){
		console.log('création de l\'entête du tableau : ' + theTableauEntete);
		var cellules = [];
		$.each(getListeSalles(listeSoutenance), function(index, value){
			$(theTableauEntete).append($('<td>' + value + '</td>'));
		});
		console.log('entête faite : ' + theTableauEntete);
	}

	function addHeaders(firstLine, deb, end, months){
		var i = new Date(deb);
		$.each($(firstLine + ' td'), function(index, value){
			if(index != 0){
				$(value).html($(value).html() + ' '
					+ i.getDate() + ' ' + months[i.getMonth()]);
				i.setDate(i.getDate() + 1);
			}
		});
	}

	function identifierCellule(selecteurTbody, listeSoutenance){
		console.log('mise en place des id sur chaque td');
		var nbDeSalles = getListeSalles(listeSoutenance).length;
		console.log(nbDeSalles + ' colonnes par lignes');
		var ptDeDepart = $(selecteurTbody + ' tr:nth-child(2)');
		// l'index commencera à 1 donc on le compence avec ptDeDepart
		ptDeDepart = ptDeDepart.attr('id').split("_")[1] - 1;
		var firstLoop = true;
		$.each($(selecteurTbody + ' tr'), function(index, value){
			if( ! firstLoop){
				for ( var i = 0; i < nbDeSalles; i++ ) {
					$(this).append('<td id="l_' + (parseInt(ptDeDepart) + index) + '_c_' + i + '"></td>')
					console.log('généré : <td id="l_' + (parseInt(ptDeDepart) + index) + '_c_' + i + '"></td>')
				}
			}
			firstLoop = false;
		});
	}

	function getCelluleCompletee(informationsStage){
		var infoEtu = informationsStage['etudiant']['prenom'] + 
			' ' + 
			informationsStage['etudiant']['nom'];
		var infoEnt = informationsStage['entreprise']['nom'];
		var infoMDS = informationsStage['enseignantTuteur']['prenom'] +
			' ' +
			informationsStage['enseignantTuteur']['nom'];
		console.log('infos sur le stage :');
		console.log(infoEtu);
		console.log(infoEnt);
		console.log(infoMDS);

		var res = '<a href="./' + informationsStage['id'] + '" target="_blank">' +
			infoEtu + ' chez ' +
			infoEnt + '<br />avec "' + infoMDS + '"</a>';
		console.log(res);
		return res;
	}

	function remplirTableauxJ(bodyTab, data){
		var salles = getListeSalles(data);
		$.each(data, function( index, value ) {
			var heure = value['fields']['datePassage']
				// recuperation de l'heure et minutes
				.split("T")[1]
				// recuperation seule de l'heure
				.split(":")[0];

			var salle = 0;
			for(i = 0; i < salles.length; i++){
				if(value['fields']['salle'] == salles[i]){
					salle = i;
				}
			}

			// recherche de l'id de la cellule cible
			var target = '#l_' + heure + '_c_' + salle;

			console.log('soutenance sur ' + target);
			$(target).html(
				getCelluleCompletee(
					value['fields']['stage']));
		});
	}

	function remplirTableaux(bodyTab, data){
		$.each(data, function( index, value ) {
			var heure = value['fields']['datePassage']
				// recuperation de l'heure et minutes
				.split("T")[1]
				// recuperation seule de l'heure
				.split(":")[0];

			var laDate = value['fields']['datePassage']
				// recuperation de la date sans l'heure
				.split('T')[0]
				// mise en tableau de l'année, mois, jour
				.split('-');
			var jour = new Date(laDate[0], laDate[1] - 1, laDate[2]).getDay();

			// recherche de l'id de la cellule cible
			var target = '#l_' + heure + '_d_' + jour;

			console.log('soutenance sur ' + target);
			$(target).html($(target).html() + value['fields']['salle']);
		});
	}

	$( document ).ready( function() {

		becomeDatePicker("#id_datePassage");

		$("#id_datePassage").change(function(){

			// Modification du tableau par jour
			$.ajax({
				url: '{% url 'find_planning' %}',
				data: {
					'date': $("#id_datePassage").val()
				},
				type: 'GET',
				dataType: 'json',
				contentType: 'application/json'
			}).done(function(data, textStatus, jqXHR){

				reinitTableaux(bodyTabJ, saveTableauJ);
				putTheadTabbleau(theadTabJ, data);
				identifierCellule(tabJ, data);
				remplirTableauxJ(bodyTabJ, data);

			}).fail(function(jqXHR, textStatus, errorThrown){
				console.log("ajax failed");
				alert(errorThrown);
			});

			// Modification du tableau par semaine
			console.log('récupération du range de la semaine');
			var laDate = $('#id_datePassage').val()
					// recuperation de la date sans l'heure
					.split('T')[0]
					// mise en tableau de l'année, mois, jour
					.split('-');
			var jour = new Date(laDate[0], laDate[1] - 1, laDate[2]);
			var curJour = new Date(jour), finSem = new Date(jour);
			curJour.setDate(parseInt(laDate[2]) - (jour.getDay() - 1));
			finSem.setDate(parseInt(laDate[2]) + (6 - jour.getDay()));
			console.log('commence : ' + curJour);
			console.log('termine : ' + finSem);

			reinitTableaux(bodyTab, saveTableau);
			addHeaders(tab + ' tr:first-child', curJour, finSem, month);

			for(var i = curJour; i <= finSem; i.setDate(i.getDate() + 1)){
				console.log('range : ' + i);
				$.ajax({
					url: '{% url 'find_planning' %}',
					data: {
						'date': i.toLocaleFormat("%Y-%m-%d")
					},
					type: 'GET',
					dataType: 'json',
					contentType: 'application/json'
				}).done(function(data, textStatus, jqXHR){

					remplirTableaux(bodyTab, data);

				}).fail(function(jqXHR, textStatus, errorThrown){
					console.log("ajax failed");
					alert(errorThrown);
				});
			}
		});
	});
	active_tab="#tab-planning"
{% endblock %}